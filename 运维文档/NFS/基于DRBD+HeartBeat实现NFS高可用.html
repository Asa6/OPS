<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>基于DRBD+HeartBeat实现NFS高可用</title>
<link rel="stylesheet" href="https://stackedit.io/res-min/themes/base.css" />
<script type="text/javascript" src="https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS_HTML"></script>
</head>
<body><div class="container"><ul>
<li><h3 id="环境介绍">环境介绍</h3><h3 id="title"></h3></li>
</ul>

<hr>

<table>
<thead>
<tr>
  <th>ID</th>
  <th>OS</th>
  <th>IP</th>
  <th>Role</th>
  <th>Server</th>
</tr>
</thead>
<tbody><tr>
  <td>node1</td>
  <td>CentOS6.5_X64</td>
  <td>192.168.1.232</td>
  <td>Master</td>
  <td>DRBD+Heartbeat+NFS</td>
</tr>
<tr>
  <td>node2</td>
  <td>CentOS6.5_X64</td>
  <td>192.168.1.208</td>
  <td>Slave</td>
  <td>DRBD+Heartbeat+NFS</td>
</tr>
<tr>
  <td></td>
  <td></td>
  <td>VIP: 192.168.1.127</td>
  <td></td>
  <td></td>
</tr>
</tbody></table>


<p></p>

<ul>
<li><h3 id="环境准备">环境准备</h3><h3 id="title-1"></h3></li>
</ul>

<hr>



<pre class="prettyprint"><code class=" hljs coffeescript">关闭SELinux和Iptables(node1和node2上配置)
[root<span class="hljs-property">@node1</span> ~]<span class="hljs-comment"># service iptables stop</span>
[root<span class="hljs-property">@node1</span> ~]<span class="hljs-comment"># chkconfig iptables off</span>
[root<span class="hljs-property">@node1</span> ~]<span class="hljs-comment"># setenforce 0</span>
[root<span class="hljs-property">@node1</span> ~]<span class="hljs-comment"># sed -i '/^SELINUX=/{ s/enforcing/disabled/ }' /etc/selinux/config</span>


配置hosts文件(node1和node2上配置)
[root<span class="hljs-property">@node1</span> ~]<span class="hljs-comment"># echo 192.168.1.232 node1 &gt;&gt; /etc/hosts</span>
[root<span class="hljs-property">@node1</span> ~]<span class="hljs-comment"># echo 192.168.1.208 node2 &gt;&gt; /etc/hosts</span>


配置时间同步(node1和node2上配置)
[root<span class="hljs-property">@node1</span> ~]<span class="hljs-comment"># yum -y install ntp</span>
[root<span class="hljs-property">@node1</span> ~]<span class="hljs-comment"># service ntpd start</span>
[root<span class="hljs-property">@node1</span> ~]<span class="hljs-comment"># \cp /usr/share/zoneinfo/Asia/Shanghai /etc/localtime</span>
[root<span class="hljs-property">@node1</span> ~]<span class="hljs-comment"># ntpdate us.pool.ntp.org</span>


配置LVM(node1和node2上配置)
[root<span class="hljs-property">@node1</span> ~]<span class="hljs-comment"># yum -y install parted lvm2</span>
[root<span class="hljs-property">@node1</span> ~]<span class="hljs-comment"># fdisk /dev/sdb   </span>
<span class="hljs-comment"># 按照下方的指示输入</span>
n<span class="hljs-function"> -&gt;</span> p<span class="hljs-function"> -&gt;</span> <span class="hljs-number">1</span><span class="hljs-function"> -&gt;</span> 回车<span class="hljs-function"> -&gt;</span> 回车<span class="hljs-function"> -&gt;</span> t<span class="hljs-function"> -&gt;</span> <span class="hljs-number">8</span>e<span class="hljs-function"> -&gt;</span> w
[root<span class="hljs-property">@node1</span> ~]<span class="hljs-comment"># partprobe /dev/sdb1</span>
[root<span class="hljs-property">@node1</span> ~]<span class="hljs-comment"># pvcreate /dev/sdb1</span>
[root<span class="hljs-property">@node1</span> ~]<span class="hljs-comment"># vgcreate vgtest /dev/sdb1</span>
[root<span class="hljs-property">@node1</span> ~]<span class="hljs-comment"># lvcreate -n lvtest -L 3G vgtest</span>
[root<span class="hljs-property">@node1</span> ~]<span class="hljs-comment"># lvs</span>
  LV     VG     Attr       LSize Pool Origin Data%  Meta%  Move Log Cpy%Sync Convert
  lvtest vgtest -wi-a----- <span class="hljs-number">3.00</span>g</code></pre>

<p></p>

<ul>
<li><h3 id="安装drbd">安装DRBD</h3><h3 id="title-2"></h3></li>
</ul>

<hr>

<pre class="prettyprint"><code class=" hljs ruby">在node1和node2上配置
[root<span class="hljs-variable">@node1</span> ~]<span class="hljs-comment"># yum -y install wget</span>
[root<span class="hljs-variable">@node1</span> ~]<span class="hljs-comment"># cd /usr/local/src/</span>
[root<span class="hljs-variable">@node1</span> ~]<span class="hljs-comment"># wget http://www.elrepo.org/elrepo-release-6-6.el6.elrepo.noarch.rpm</span>
[root<span class="hljs-variable">@node1</span> ~]<span class="hljs-comment"># rpm -ivh elrepo-release-6-6.el6.elrepo.noarch.rpm</span>
[root<span class="hljs-variable">@node1</span> ~]<span class="hljs-comment"># yum -y install drbd83-utils kmod-drbd83</span>
[root<span class="hljs-variable">@node1</span> ~]<span class="hljs-comment"># reboot    # 因为安装DRBD时对内核进行了更新，所以必须重启生效</span>
[root<span class="hljs-variable">@node1</span> ~]<span class="hljs-comment"># modprobe drbd    # 加载drbd模块</span></code></pre>



<pre class="prettyprint"><code class=" hljs ruby">检查<span class="hljs-constant">DRBD</span>是否安装成功
[root<span class="hljs-variable">@node1</span> ~]<span class="hljs-comment"># modprobe -l | grep drbd</span>
weak-updates/drbd83/drbd.ko
[root<span class="hljs-variable">@node1</span> ~]<span class="hljs-comment"># lsmod | grep drbd</span>
drbd                  <span class="hljs-number">332493</span>  <span class="hljs-number">0</span></code></pre>

<p></p>

<ul>
<li><h3 id="配置drbd">配置DRBD</h3><h3 id="title-3"></h3></li>
</ul>

<hr>



<pre class="prettyprint"><code class=" hljs applescript">配置DRBD(node1和node2上配置),两台主机配置文件一模一样
[root@node1 ~]<span class="hljs-comment"># cp /usr/share/doc/drbd83-utils-8.3.16/drbd.conf.example /etc/drbd.conf.old</span>
<span class="hljs-comment"># 修改配置文件，如下:</span>
[root@node1 ~]<span class="hljs-comment"># &gt; /etc/drbd.conf   # 清空这个文件</span>
[root@node1 ~]<span class="hljs-comment"># vi /etc/drbd.conf</span>
<span class="hljs-comment"># You can find an example in  /usr/share/doc/drbd.../drbd.conf.example</span>

<span class="hljs-keyword">global</span> {
    usage-<span class="hljs-command">count</span> no;      <span class="hljs-comment">#是否参加DRBD使用者统计，默认为yes</span>
}

common {
    syncer {
        rate <span class="hljs-number">100</span>M;       <span class="hljs-comment">#设置主、备节点同步时的网络速率最大值</span>
    }
}

resource r0 {
    <span class="hljs-comment">#资源名为r0</span>
    protocol C;
    <span class="hljs-comment">#使用DRBD的第三种同步协议，表示收到远程主机的写入确认后认为写入完成</span>

    startup {
        wfc-<span class="hljs-keyword">timeout</span> <span class="hljs-number">120</span>;
        degr-wfc-<span class="hljs-keyword">timeout</span> <span class="hljs-number">120</span>;
    }

    disk {
        <span class="hljs-function_start"><span class="hljs-keyword">on</span></span>-io-<span class="hljs-keyword">error</span> detach;
        fencing resource-only;
    }

    net {
        <span class="hljs-keyword">timeout</span> <span class="hljs-number">60</span>;
        connect-int <span class="hljs-number">10</span>;
        ping-int <span class="hljs-number">10</span>;
        max-buffers <span class="hljs-number">2048</span>;
        max-epoch-size <span class="hljs-number">2048</span>;
        cram-hmac-alg <span class="hljs-string">"sha1"</span>;
        shared-secret <span class="hljs-string">"MYSAL-HA"</span>;
        <span class="hljs-comment">#DRBD同步时使用的验证方式和密码</span>
    }

    <span class="hljs-function_start"><span class="hljs-keyword">on</span></span> node1 {
        <span class="hljs-comment">#每个主机的说明以on开头,on后面必须是主机名，即：hostname</span>
        device /dev/drbd0;      <span class="hljs-comment">#DRBD设备名</span>
        disk   /dev/mapper/vgtest-lvtest;       <span class="hljs-comment">#DRBD设备/dev/drbd0所使用的分区</span>
        address <span class="hljs-number">192.168</span><span class="hljs-number">.1</span><span class="hljs-number">.232</span>:<span class="hljs-number">7788</span>;      <span class="hljs-comment">#设置DRBD的监听端口，用于与另一台主机通信</span>
        meta-disk internal;                <span class="hljs-comment">#表示在同一个局域网内</span>
    }

    <span class="hljs-function_start"><span class="hljs-keyword">on</span></span> node2 {
        device /dev/drbd0;      <span class="hljs-comment">#DRBD设备名</span>
        disk   /dev/mapper/vgtest-lvtest;       <span class="hljs-comment">#所使用的分区</span>
        address <span class="hljs-number">192.168</span><span class="hljs-number">.1</span><span class="hljs-number">.208</span>:<span class="hljs-number">7788</span>;
        meta-disk internal;           <span class="hljs-comment">#DRBD的元数据存放方式</span>
    }
}</code></pre>



<pre class="prettyprint"><code class=" hljs perl">启动DRBD(node1和node2上执行)
[root<span class="hljs-variable">@node1</span> ~]<span class="hljs-comment"># mknod /dev/drbd0 b 147 0  # 创建DRBD设备</span>
[root<span class="hljs-variable">@node1</span> ~]<span class="hljs-comment"># drbdadm create-md r0      # 激活DRBD设备，看到successfully说明成功</span>
Writing meta data...
initializing activity <span class="hljs-keyword">log</span>
NOT initialized bitmap
New drbd meta data block successfully created.

<span class="hljs-comment"># 启动第一台的时候需要等一会，然后提示输入yes。第二台不用输入yes，执行即可。</span>
[root<span class="hljs-variable">@node1</span> ~]<span class="hljs-comment"># /etc/init.d/drbd start</span></code></pre>



<pre class="prettyprint"><code class=" hljs vala">查看DRBD的启动清空
[root@node1 ~]# /etc/init.d/drbd status
drbd driver loaded OK; device status:
version: <span class="hljs-number">8.3</span><span class="hljs-number">.16</span> (api:<span class="hljs-number">88</span>/proto:<span class="hljs-number">86</span>-<span class="hljs-number">97</span>)
GIT-hash: a798fa7e274428a357657fb52f0ecf40192c1985 build by phil@Build64R6, <span class="hljs-number">2014</span>-<span class="hljs-number">11</span>-<span class="hljs-number">24</span> <span class="hljs-number">14</span>:<span class="hljs-number">51</span>:<span class="hljs-number">37</span>
m:res  cs         ro                   ds                         p  mounted  fstype
<span class="hljs-number">0</span>:r0   Connected  Secondary/Secondary  Inconsistent/Inconsistent  C
<span class="hljs-preprocessor">#注意：只有主备两边的DRBD都启动起来才会生效</span>
<span class="hljs-preprocessor">#ro：角色信息，此时的状态为Secondary/Secondary，表示两台主机的状态都是备机状态</span>
<span class="hljs-preprocessor">#ds：磁盘状态，Inconsistent/Inconsistent显示的状态内容“不一致”，这是因为DRBD无法判断哪一方为主机，应以哪一方的磁盘数据作为标准</span>
<span class="hljs-preprocessor">#dw：磁盘写操作</span>
<span class="hljs-preprocessor">#dr：磁盘读操作</span></code></pre>



<pre class="prettyprint"><code class=" hljs brainfuck"><span class="hljs-comment">设置主节点(node1上执行)</span>
<span class="hljs-comment">这里在node1上执行，便将node1设为主节点了</span>
<span class="hljs-title">[</span><span class="hljs-comment">root@node1</span> <span class="hljs-comment">~</span><span class="hljs-title">]</span><span class="hljs-comment">#</span> <span class="hljs-comment">drbdadm</span>  <span class="hljs-literal">-</span><span class="hljs-literal">-</span> <span class="hljs-literal">-</span><span class="hljs-literal">-</span><span class="hljs-comment">overwrite</span><span class="hljs-literal">-</span><span class="hljs-comment">data</span><span class="hljs-literal">-</span><span class="hljs-comment">of</span><span class="hljs-literal">-</span><span class="hljs-comment">peer</span> <span class="hljs-comment">primary</span> <span class="hljs-comment">all</span></code></pre>



<pre class="prettyprint"><code class=" hljs applescript">[root@node1 ~]<span class="hljs-comment"># cat /proc/drbd   # 再次查看DRBD状态</span>
<span class="hljs-property">version</span>: <span class="hljs-number">8.3</span><span class="hljs-number">.16</span> (api:<span class="hljs-number">88</span>/proto:<span class="hljs-number">86</span>-<span class="hljs-number">97</span>)
GIT-hash: a798fa7e274428a357657fb52f0ecf40192c1985 build <span class="hljs-keyword">by</span> phil@Build64R6, <span class="hljs-number">2014</span>-<span class="hljs-number">11</span>-<span class="hljs-number">24</span> <span class="hljs-number">14</span>:<span class="hljs-number">51</span>:<span class="hljs-number">37</span>
 <span class="hljs-number">0</span>: cs:SyncSource ro:Primary/Secondary ds:UpToDate/Inconsistent C r<span class="hljs-comment">-----</span>
    ns:<span class="hljs-number">344064</span> nr:<span class="hljs-number">0</span> dw:<span class="hljs-number">0</span> dr:<span class="hljs-number">344728</span> al:<span class="hljs-number">0</span> bm:<span class="hljs-number">21</span> lo:<span class="hljs-number">0</span> pe:<span class="hljs-number">0</span> ua:<span class="hljs-number">0</span> ap:<span class="hljs-number">0</span> ep:<span class="hljs-number">1</span> wo:f oos:<span class="hljs-number">2801532</span>
    [=&gt;..................] sync'ed: <span class="hljs-number">11.1</span>% (<span class="hljs-number">2801532</span>/<span class="hljs-number">3145596</span>)K
    finish: <span class="hljs-number">0</span>:<span class="hljs-number">01</span>:<span class="hljs-number">05</span> speed: <span class="hljs-number">43</span>,<span class="hljs-number">008</span> (<span class="hljs-number">43</span>,<span class="hljs-number">008</span>) K/sec
<span class="hljs-comment">#ro:Primary/Secondary ds:UpToDate/Inconsistent，此时dbm135为Primary，另一台主机为Secondary，且数据正在同步UpToDate/Inconsistent</span>


[root@node1 ~]<span class="hljs-comment"># cat /proc/drbd   # 等一段时间，再次查看DRBD状态</span>
<span class="hljs-property">version</span>: <span class="hljs-number">8.3</span><span class="hljs-number">.16</span> (api:<span class="hljs-number">88</span>/proto:<span class="hljs-number">86</span>-<span class="hljs-number">97</span>)
GIT-hash: a798fa7e274428a357657fb52f0ecf40192c1985 build <span class="hljs-keyword">by</span> phil@Build64R6, <span class="hljs-number">2014</span>-<span class="hljs-number">11</span>-<span class="hljs-number">24</span> <span class="hljs-number">14</span>:<span class="hljs-number">51</span>:<span class="hljs-number">37</span>
 <span class="hljs-number">0</span>: cs:Connected ro:Primary/Secondary ds:UpToDate/UpToDate C r<span class="hljs-comment">-----</span>
    ns:<span class="hljs-number">3145596</span> nr:<span class="hljs-number">0</span> dw:<span class="hljs-number">0</span> dr:<span class="hljs-number">3146260</span> al:<span class="hljs-number">0</span> bm:<span class="hljs-number">192</span> lo:<span class="hljs-number">0</span> pe:<span class="hljs-number">0</span> ua:<span class="hljs-number">0</span> ap:<span class="hljs-number">0</span> ep:<span class="hljs-number">1</span> wo:f oos:<span class="hljs-number">0</span>
<span class="hljs-comment">#ds:UpToDate/UpToDate，数据同步完成</span>


[root@node2 ~]<span class="hljs-comment"># cat /proc/drbd # 在node2上查看DRBD状态</span>
<span class="hljs-property">version</span>: <span class="hljs-number">8.3</span><span class="hljs-number">.16</span> (api:<span class="hljs-number">88</span>/proto:<span class="hljs-number">86</span>-<span class="hljs-number">97</span>)
GIT-hash: a798fa7e274428a357657fb52f0ecf40192c1985 build <span class="hljs-keyword">by</span> phil@Build64R6, <span class="hljs-number">2014</span>-<span class="hljs-number">11</span>-<span class="hljs-number">24</span> <span class="hljs-number">14</span>:<span class="hljs-number">51</span>:<span class="hljs-number">37</span>
 <span class="hljs-number">0</span>: cs:Connected ro:Secondary/Primary ds:UpToDate/UpToDate C r<span class="hljs-comment">-----</span>
    ns:<span class="hljs-number">0</span> nr:<span class="hljs-number">3145596</span> dw:<span class="hljs-number">3145596</span> dr:<span class="hljs-number">0</span> al:<span class="hljs-number">0</span> bm:<span class="hljs-number">192</span> lo:<span class="hljs-number">0</span> pe:<span class="hljs-number">0</span> ua:<span class="hljs-number">0</span> ap:<span class="hljs-number">0</span> ep:<span class="hljs-number">1</span> wo:f oos:<span class="hljs-number">0</span>
<span class="hljs-comment">#ro:Secondary/Primary ds:UpToDate/UpToDate，dbm134此时状态为Secondary</span></code></pre>

<p></p>

<ul>
<li><h3 id="格式化并挂载drbd设备">格式化并挂载DRBD设备</h3><h3 id="title-4"></h3></li>
</ul>

<hr>



<pre class="prettyprint"><code class=" hljs coffeescript">注意：所有的读写操作，包括对DRBD设备的格式化及挂载都必须在Primary主机进行，即node1；Secondary主机不能进行任何操作，即使读操作也不可以，连格式化和挂载也不可以
[root<span class="hljs-property">@node1</span> ~]<span class="hljs-comment"># mkfs.ext4 /dev/drbd0</span>
[root<span class="hljs-property">@node1</span> ~]<span class="hljs-comment"># mkdir /data</span>
[root<span class="hljs-property">@node1</span> ~]<span class="hljs-comment"># mount  /dev/drbd0 /data</span>
[root<span class="hljs-property">@node1</span> ~]<span class="hljs-comment"># df -h</span>
Filesystem      Size  Used Avail Use% Mounted <span class="hljs-literal">on</span>
<span class="hljs-regexp">/dev/sda3        18G  1.2G   16G   7% /</span>
tmpfs           <span class="hljs-number">931</span>M     <span class="hljs-number">0</span>  <span class="hljs-number">931</span>M   <span class="hljs-number">0</span>% /dev/shm
/dev/sda1       <span class="hljs-number">190</span>M   <span class="hljs-number">47</span>M  <span class="hljs-number">134</span>M  <span class="hljs-number">26</span>% /boot
/dev/drbd0      <span class="hljs-number">2.9</span>G  <span class="hljs-number">4.5</span>M  <span class="hljs-number">2.8</span>G   <span class="hljs-number">1</span>% /data
注意：
    Secondary节点上不允许对DRBD设备进行任何操作，即使是读操作也不行，因为此时在secondary节点上根本不能挂载DRBD设备；所有的读写操作只能在Primary节点上进行，只有当Primary节点挂掉时，Secondary节点才能提升为Primary节点继续工作</code></pre>

<p></p>

<ul>
<li><h3 id="安装heartbeat">安装HeartBeat</h3><h3 id="title-5"></h3></li>
</ul>

<hr>



<pre class="prettyprint"><code class=" hljs ruby">node1和node2上执行
[root<span class="hljs-variable">@node1</span> ~]<span class="hljs-comment"># cd /usr/local/src/</span>
[root<span class="hljs-variable">@node1</span> ~]<span class="hljs-comment"># wget http://dl.fedoraproject.org/pub/epel/6/x86_64/epel-release-6-8.noarch.rpm</span>
[root<span class="hljs-variable">@node1</span> ~]<span class="hljs-comment"># rpm -ivh epel-release-6-8.noarch.rpm</span>
[root<span class="hljs-variable">@node1</span> ~]<span class="hljs-comment"># yum -y install heartbeat</span></code></pre>

<p></p>

<ul>
<li><h3 id="配置heartbeat">配置HeartBeat</h3><h3 id="title-6"></h3></li>
</ul>

<hr>



<pre class="prettyprint"><code class=" hljs vala"><span class="hljs-preprocessor"># HeartBeat配置文件，需要手动创建</span>
[root@node1 ~]# vi /etc/ha.d/ha.cf   # node1上的配置文件
logfile         /<span class="hljs-keyword">var</span>/log/ha-log
<span class="hljs-preprocessor">#定义HA的日志名及存放位置</span>

logfacility     local0
keepalive       <span class="hljs-number">2</span>
<span class="hljs-preprocessor">#心跳发送时间间隔为2秒</span>

deadtime        <span class="hljs-number">10</span>
<span class="hljs-preprocessor">#死亡时间为10秒，备用节点10秒内没有检测到主机心跳，确认对方故障</span>

ucast           eth0 <span class="hljs-number">192.168</span><span class="hljs-number">.1</span><span class="hljs-number">.208</span>
<span class="hljs-preprocessor">#IP地址指定为对方IP</span>

auto_failback   off
<span class="hljs-preprocessor">#服务器正常后由新主服务器接管资源，另一台服务器放弃该资源，因为切换一次成本很高</span>

node            node1 node2
<span class="hljs-preprocessor">#定义节点,指定主机名 hostname</span>
</code></pre>



<pre class="prettyprint"><code class=" hljs vala">[root@node1 ~]# vi /etc/ha.d/ha.cf   # node2上的配置文件
logfile         /<span class="hljs-keyword">var</span>/log/ha-log
<span class="hljs-preprocessor">#定义HA的日志名及存放位置</span>

logfacility     local0
keepalive       <span class="hljs-number">2</span>
<span class="hljs-preprocessor">#心跳发送时间间隔为2秒</span>

deadtime        <span class="hljs-number">10</span>
<span class="hljs-preprocessor">#死亡时间为10秒，备用节点10秒内没有检测到主机心跳，确认对方故障</span>

ucast           eth0 <span class="hljs-number">192.168</span><span class="hljs-number">.1</span><span class="hljs-number">.232</span>
<span class="hljs-preprocessor">#IP地址指定为对方IP</span>

auto_failback   off
<span class="hljs-preprocessor">#服务器正常后由新主服务器接管资源，另一台服务器放弃该资源，因为切换一次成本很高</span>

node            node1 node2
<span class="hljs-preprocessor">#定义节点,指定主机名 hostname</span></code></pre>



<pre class="prettyprint"><code class=" hljs ruby"><span class="hljs-comment"># 配置双机互联验证文件authkeys(node1和node2)</span>
[root<span class="hljs-variable">@node1</span> ~]<span class="hljs-comment"># vi /etc/ha.d/authkeys</span>
auth <span class="hljs-number">1</span>
<span class="hljs-number">1</span> crc
[root<span class="hljs-variable">@node1</span> ~]<span class="hljs-comment"># chmod 600 /etc/ha.d/authkeys  # 注意，权限必须为600</span></code></pre>



<pre class="prettyprint"><code class=" hljs vala"><span class="hljs-preprocessor"># 配置集群资源文件haresources(node1和node2)</span>
[root@node1 ~]# vi /etc/ha.d/haresources
node1 IPaddr::<span class="hljs-number">192.168</span><span class="hljs-number">.1</span><span class="hljs-number">.127</span>/<span class="hljs-number">24</span>/eth0 drbddisk::r0 Filesystem::/dev/drbd0::/data::ext4 killnfsd

<span class="hljs-preprocessor">##两台主机node1和node2的此文件内容一模一样</span>
<span class="hljs-preprocessor">##主机名设置为此时的主节点（Primary）的主机名，即node1</span>
<span class="hljs-preprocessor">##Ipaddr：绑定虚拟ip，且绑定在eth0上</span>
<span class="hljs-preprocessor">##drbddisk：指定drbd的资源r0，进行主备切换</span>
<span class="hljs-preprocessor">##Filesystem：指定drbd的设备/dev/drbd0，挂载点/data，文件系统ext4，进行drbd设备的挂载</span>
<span class="hljs-preprocessor">##killnfsd：指定nfs的启动脚本，由heartbeat管理</span>
<span class="hljs-preprocessor">##drbd在进行主备切换时，HeartBeat会执行这个资源文件里指定的这四个脚本文件</span></code></pre>



<pre class="prettyprint"><code class=" hljs ruby"><span class="hljs-comment"># 配置nfs脚本文件killnfsd(node1和node2)</span>
[root<span class="hljs-variable">@node1</span> ~]<span class="hljs-comment"># vi /etc/ha.d/resource.d/killnfsd</span>
killall -<span class="hljs-number">9</span> nfsd; <span class="hljs-regexp">/etc/init</span>.d/nfs restart; exit <span class="hljs-number">0</span>
[root<span class="hljs-variable">@node1</span> ~]<span class="hljs-comment"># chmod 755 /etc/ha.d/resource.d/killnfsd</span></code></pre>



<pre class="prettyprint"><code class=" hljs ruby"><span class="hljs-comment"># 查看drbddisk Filesystem killnfsd IPaddr这四个文件是否都存在</span>
[root<span class="hljs-variable">@node1</span> ~]<span class="hljs-comment"># cd /etc/ha.d/resource.d/</span>
[root<span class="hljs-variable">@node1</span> resource.d]<span class="hljs-comment"># ll drbddisk Filesystem killnfsd IPaddr</span></code></pre>

<p></p>

<ul>
<li><h3 id="配置nfs">配置NFS</h3><h3 id="title-7"></h3></li>
</ul>

<hr>



<pre class="prettyprint"><code class=" hljs ruby"><span class="hljs-comment"># node1和node2上配置</span>
[root<span class="hljs-variable">@node1</span> ~]<span class="hljs-comment"># vi /etc/exports</span>
/data *(rw,no_root_squash,sync)
[root<span class="hljs-variable">@node1</span> ~]<span class="hljs-comment"># chkconfig rpcbind on</span>
[root<span class="hljs-variable">@node1</span> ~]<span class="hljs-comment"># chkconfig nfs off        #nfs不需要设置开机自动启动，因为nfs的启动由heartbeat管理</span>
[root<span class="hljs-variable">@node1</span> ~]<span class="hljs-comment"># /etc/init.d/rpcbind start</span></code></pre>

<p></p>

<ul>
<li><h3 id="启动heartbeat">启动HeartBeat</h3><h3 id="title-8"></h3></li>
</ul>

<hr>



<pre class="prettyprint"><code class=" hljs perl">node1和node2上执行
注意：先在主节点上启动(node1是primary)
[root<span class="hljs-variable">@node1</span> ~]<span class="hljs-comment"># /etc/init.d/heartbeat start</span>
[root<span class="hljs-variable">@node1</span> ~]<span class="hljs-comment"># chkconfig heartbeat on</span>
[root<span class="hljs-variable">@node1</span> ~]<span class="hljs-comment"># ps -ef | grep heartbeat</span>
root       <span class="hljs-number">1715</span>      <span class="hljs-number">1</span>  <span class="hljs-number">0</span> <span class="hljs-number">19</span>:<span class="hljs-number">11</span> ?        <span class="hljs-number">00</span>:<span class="hljs-number">00</span>:<span class="hljs-number">00</span> heartbeat: master control process
root       <span class="hljs-number">1719</span>   <span class="hljs-number">1715</span>  <span class="hljs-number">0</span> <span class="hljs-number">19</span>:<span class="hljs-number">11</span> ?        <span class="hljs-number">00</span>:<span class="hljs-number">00</span>:<span class="hljs-number">00</span> heartbeat: FIFO reader        
root       <span class="hljs-number">1720</span>   <span class="hljs-number">1715</span>  <span class="hljs-number">0</span> <span class="hljs-number">19</span>:<span class="hljs-number">11</span> ?        <span class="hljs-number">00</span>:<span class="hljs-number">00</span>:<span class="hljs-number">00</span> heartbeat: <span class="hljs-keyword">write</span>: ucast eth<span class="hljs-number">0</span>  
root       <span class="hljs-number">1721</span>   <span class="hljs-number">1715</span>  <span class="hljs-number">0</span> <span class="hljs-number">19</span>:<span class="hljs-number">11</span> ?        <span class="hljs-number">00</span>:<span class="hljs-number">00</span>:<span class="hljs-number">00</span> heartbeat: <span class="hljs-keyword">read</span>: ucast eth<span class="hljs-number">0</span>   
root       <span class="hljs-number">1744</span>   <span class="hljs-number">1195</span>  <span class="hljs-number">0</span> <span class="hljs-number">19</span>:<span class="hljs-number">11</span> pts/<span class="hljs-number">0</span>    <span class="hljs-number">00</span>:<span class="hljs-number">00</span>:<span class="hljs-number">00</span> <span class="hljs-keyword">grep</span> heartbeat
[root<span class="hljs-variable">@node1</span> ~]<span class="hljs-comment"># ps -ef | grep nfs   #查看主节点上的nfs是否启动</span>
root       <span class="hljs-number">2767</span>      <span class="hljs-number">2</span>  <span class="hljs-number">0</span> <span class="hljs-number">19</span>:<span class="hljs-number">11</span> ?        <span class="hljs-number">00</span>:<span class="hljs-number">00</span>:<span class="hljs-number">00</span> [nfsd4]
root       <span class="hljs-number">2768</span>      <span class="hljs-number">2</span>  <span class="hljs-number">0</span> <span class="hljs-number">19</span>:<span class="hljs-number">11</span> ?        <span class="hljs-number">00</span>:<span class="hljs-number">00</span>:<span class="hljs-number">00</span> [nfsd4_callbacks]
root       <span class="hljs-number">2769</span>      <span class="hljs-number">2</span>  <span class="hljs-number">0</span> <span class="hljs-number">19</span>:<span class="hljs-number">11</span> ?        <span class="hljs-number">00</span>:<span class="hljs-number">00</span>:<span class="hljs-number">00</span> [nfsd]
root       <span class="hljs-number">2770</span>      <span class="hljs-number">2</span>  <span class="hljs-number">0</span> <span class="hljs-number">19</span>:<span class="hljs-number">11</span> ?        <span class="hljs-number">00</span>:<span class="hljs-number">00</span>:<span class="hljs-number">00</span> [nfsd]
root       <span class="hljs-number">2771</span>      <span class="hljs-number">2</span>  <span class="hljs-number">0</span> <span class="hljs-number">19</span>:<span class="hljs-number">11</span> ?        <span class="hljs-number">00</span>:<span class="hljs-number">00</span>:<span class="hljs-number">00</span> [nfsd]
root       <span class="hljs-number">2772</span>      <span class="hljs-number">2</span>  <span class="hljs-number">0</span> <span class="hljs-number">19</span>:<span class="hljs-number">11</span> ?        <span class="hljs-number">00</span>:<span class="hljs-number">00</span>:<span class="hljs-number">00</span> [nfsd]
root       <span class="hljs-number">2773</span>      <span class="hljs-number">2</span>  <span class="hljs-number">0</span> <span class="hljs-number">19</span>:<span class="hljs-number">11</span> ?        <span class="hljs-number">00</span>:<span class="hljs-number">00</span>:<span class="hljs-number">00</span> [nfsd]
root       <span class="hljs-number">2774</span>      <span class="hljs-number">2</span>  <span class="hljs-number">0</span> <span class="hljs-number">19</span>:<span class="hljs-number">11</span> ?        <span class="hljs-number">00</span>:<span class="hljs-number">00</span>:<span class="hljs-number">00</span> [nfsd]
root       <span class="hljs-number">2775</span>      <span class="hljs-number">2</span>  <span class="hljs-number">0</span> <span class="hljs-number">19</span>:<span class="hljs-number">11</span> ?        <span class="hljs-number">00</span>:<span class="hljs-number">00</span>:<span class="hljs-number">00</span> [nfsd]
root       <span class="hljs-number">2776</span>      <span class="hljs-number">2</span>  <span class="hljs-number">0</span> <span class="hljs-number">19</span>:<span class="hljs-number">11</span> ?        <span class="hljs-number">00</span>:<span class="hljs-number">00</span>:<span class="hljs-number">00</span> [nfsd]
root       <span class="hljs-number">2909</span>   <span class="hljs-number">1195</span>  <span class="hljs-number">0</span> <span class="hljs-number">19</span>:<span class="hljs-number">12</span> pts/<span class="hljs-number">0</span>    <span class="hljs-number">00</span>:<span class="hljs-number">00</span>:<span class="hljs-number">00</span> <span class="hljs-keyword">grep</span> nfs</code></pre>

<p></p>

<ul>
<li><h3 id="配置nfs监控脚本">配置NFS监控脚本</h3><h3 id="title-9"></h3></li>
</ul>

<hr>



<pre class="prettyprint"><code class=" hljs lua"># 经测试，发现主节点的NFS挂掉时，HeartBeat不会进行故障切换，所以需要自行编写监控脚本，解决无法切换的问题。
# 脚本说明：
    因为进行一次故障切换的成本太高，所以发现主节点的NFS停机时，会先尝试启动NFS。如果NFS无法启动，会停止主节点的HeartBeat，进行故障切换。
# node1和node2上执行
[root@node1 ~]# mkdir -p /opt/monitor/nfs/
[root@node1 ~]# vi /opt/monitor/nfs/monitornfs.sh
#!/bin/bash
<span class="hljs-keyword">while</span> <span class="hljs-keyword">true</span>; <span class="hljs-keyword">do</span>
    DRBD_status=$(cat /proc/drbd | grep ro | tail -n1 | awk -F<span class="hljs-string">':'</span> <span class="hljs-string">'{print $4}'</span> | awk -F<span class="hljs-string">'/'</span> <span class="hljs-string">'{print $1}'</span>)
    NFS_status=$(/etc/init.d/nfs status | grep -c pid)

    <span class="hljs-keyword">if</span> <span class="hljs-string">[[ $DRBD_status == 'Primary' ]]</span>; <span class="hljs-keyword">then</span>
        <span class="hljs-keyword">if</span> <span class="hljs-string">[[ $NFS_status -eq 0 ]]</span>; <span class="hljs-keyword">then</span>
            /etc/init.d/nfs start &amp;&gt; /dev/null
            NEWNFS_status=$(/etc/init.d/nfs status | grep -c pid)
            <span class="hljs-keyword">if</span> <span class="hljs-string">[[ $NEWNFS_status -eq 0 ]]</span>; <span class="hljs-keyword">then</span>
                /etc/init.d/heartbeat stop &amp;&gt; /dev/null
                DATE=$(date +%Y-%m-%d<span class="hljs-string">" "</span>%T)
                echo <span class="hljs-string">"$DATE  发现Primary主机上的nfs无法启动，已经进行故障切换！"</span> &gt;&gt; /var/log/Monitor.log
            fi
            DATE=$(date +%Y-%m-%d<span class="hljs-string">" "</span>%T)
            echo <span class="hljs-string">"$DATE  发现Primary主机上的NFS意外停止，已经将其启动！"</span> &gt;&gt; /var/log/Monitor.log
        fi
    <span class="hljs-keyword">else</span>
        <span class="hljs-keyword">if</span> <span class="hljs-string">[[ $NFS_status -ne 0 ]]</span>; <span class="hljs-keyword">then</span>
            /etc/init.d/nfs stop &amp;&gt; /dev/null
            DATE=$(date +%Y-%m-%d<span class="hljs-string">" "</span>%T)
            echo <span class="hljs-string">"$DATE  发现Secondary主机的NFS正在运行，已经将其关闭！"</span> &gt;&gt; /var/log/Monitor.log
        fi
    fi
    sleep <span class="hljs-number">3</span>
done
##注意：不要将此监控脚本放到挂载目录中，在这里也就是/data，因为挂载drbd设备时，会把此脚本覆盖掉。
[root@node1 ~]# chmod  u+x /opt/monitor/nfs/monitornfs.sh
[root@node1 ~]# nohup bash /opt/monitor/nfs/monitornfs.sh &amp;   # 放在后台运行
[root@node1 ~]# vi /etc/rc.d/rc.<span class="hljs-keyword">local</span>   # 设置开机执行
nohup bash /opt/monitor/nfs/monitornfs.sh &amp;</code></pre>

<p></p>

<ul>
<li><h3 id="高可用测试">高可用测试</h3><h3 id="title-10"></h3></li>
</ul>

<hr></div></body>
</html>